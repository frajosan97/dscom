import{r as m,j as a}from"./app-CG0rYmwP.js";import{u as L}from"./useData-7VE-1-99.js";import{a as D}from"./helpers-D52D6J_C.js";import{u as z,w as V,K as H,L as _,M as Y,N as K,O as G,P as Q,m as U,Q as W}from"./index-CkxFe3AD.js";import{C as i}from"./Card-CewoDW1c.js";import{S as J}from"./Spinner-DOcr2JCN.js";import{A as F}from"./Alert-Bz1djl1I.js";import{T as X}from"./Tabs-BOtz-nHt.js";import{T as Z}from"./Tab-M-Rso0-C.js";import{T as C}from"./Table-DxO-cu9g.js";import{B as $}from"./Image-DOSiFVRD.js";import{c as ee}from"./Form-DBT1bdVP.js";const w={cash:W,mpesa:U,cheque:Q,bank:G,card:_,paypal:K,crypto:Y,default:_},S={cash:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},name:{type:"text",label:"Name",placeholder:"Name"},phone:{type:"text",label:"Phone",placeholder:"Phone Number"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["name","amount"]},mpesa:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},transId:{type:"text",label:"Transaction ID",placeholder:"Transaction ID"},name:{type:"text",label:"Name",placeholder:"Name"},phone:{type:"text",label:"Phone",placeholder:"Phone Number"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["transId","phone","amount"]},cheque:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},bankName:{type:"text",label:"Bank",placeholder:"Bank Name"},branch:{type:"text",label:"Branch",placeholder:"Branch"},chequeNo:{type:"text",label:"Cheque No",placeholder:"Cheque Number"},account:{type:"text",label:"Account",placeholder:"Account Number"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["chequeNo","bankName","amount"]},card:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},cardNumber:{type:"text",label:"Card No",placeholder:"Card Number"},cardHolder:{type:"text",label:"Card Holder",placeholder:"Card Holder Name"},expiry:{type:"text",label:"Expiry",placeholder:"MM/YY"},cvv:{type:"text",label:"CVV",placeholder:"CVV"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["cardNumber","cardHolder","amount"]},bank:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},bankName:{type:"text",label:"Bank",placeholder:"Bank Name"},accountNumber:{type:"text",label:"Account",placeholder:"Account Number"},reference:{type:"text",label:"Reference",placeholder:"Reference Number"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["accountNumber","reference","amount"]},default:{fields:{date:{type:"date",label:"Date",placeholder:"Date"},reference:{type:"text",label:"Reference",placeholder:"Reference Number"},description:{type:"text",label:"Description",placeholder:"Description"},amount:{type:"number",label:"Amount",placeholder:"Amount"}},required:["reference","amount"]}},N={required:"This field is required",phone:"Please enter a valid phone number",amount:"Please enter a valid amount",date:"Please select a valid date"},pe=({paymentData:y,setPaymentData:g,cartTotal:p=0})=>{const{paymentMethods:c,isLoading:T,error:A}=L(),[f,j]=m.useState({}),[b,h]=m.useState({}),[E,v]=m.useState(null),d=e=>{const t=e==null?void 0:e.toLowerCase();return S[t]||S.default},k=e=>{const t=e==null?void 0:e.toLowerCase(),n=w[t]||w.default;return a.jsx(n,{className:"me-2"})};m.useEffect(()=>{var t;if(!c||c.length===0)return;const e={};c.forEach(n=>{const s=d(n.code).fields;e[n.code]=Object.keys(s).reduce((r,o)=>(r[o]=o==="date"?new Date().toISOString().split("T")[0]:"",r),{})}),j(e),(t=c[0])!=null&&t.code&&v(c[0].code)},[c]);const x=m.useMemo(()=>Object.values(y).flat().reduce((e,t)=>e+(parseFloat(t.amount)||0),0),[y]);m.useMemo(()=>p-x,[p,x]);const q=(e,t,n)=>{j(l=>({...l,[e]:{...l[e],[t]:n}})),b[`${e}_${t}`]&&h(l=>{const s={...l};return delete s[`${e}_${t}`],s})},I=e=>{const t=f[e],n=d(e),l={};n.required.forEach(r=>{(!t[r]||t[r].toString().trim()==="")&&(l[`${e}_${r}`]=N.required)});const s=parseFloat(t.amount);return(isNaN(s)||s<=0)&&(l[`${e}_amount`]=N.amount),n.required.includes("phone")&&t.phone&&(/^[0-9]{10,15}$/.test(t.phone.replace(/\D/g,""))||(l[`${e}_phone`]=N.phone)),t.date&&!B(t.date)&&(l[`${e}_date`]=N.date),h(l),Object.keys(l).length===0},B=e=>{const t=new Date(e);return t instanceof Date&&!isNaN(t)},O=e=>{if(!I(e))return;const t=f[e],n=c.find(r=>r.code===e),l=parseFloat(t.amount);if(x+l>p){h(r=>({...r,[`${e}_amount`]:`Amount exceeds remaining balance of ${D(p-x)}`}));return}const s={id:Date.now()+Math.random(),...t,amount:l,payment_method_id:n==null?void 0:n.id,payment_method_name:n==null?void 0:n.name,payment_method_code:e,timestamp:new Date().toISOString()};g(r=>({...r,[e]:[...r[e]||[],s]})),j(r=>({...r,[e]:Object.keys(d(e).fields).reduce((o,u)=>(o[u]=u==="date"?new Date().toISOString().split("T")[0]:"",o),{})})),h(r=>{const o={...r};return Object.keys(r).forEach(u=>{u.startsWith(`${e}_`)&&delete o[u]}),o})},P=(e,t)=>{g(n=>{const l=(n[e]||[]).filter(s=>s.id!==t);return{...n,[e]:l}})},M=e=>{const t=f[e];if(!t)return null;const l=d(e).fields;return Object.entries(l).map(([s,r])=>a.jsxs("td",{className:"p-1 align-middle",children:[a.jsx(ee,{type:r.type,placeholder:r.placeholder,value:t[s]||"",onChange:o=>q(e,s,o.target.value),className:"rounded-0",isInvalid:!!b[`${e}_${s}`],size:"sm"}),b[`${e}_${s}`]&&a.jsxs("div",{className:"small text-danger mt-1",children:[a.jsx(H,{className:"me-1"}),b[`${e}_${s}`]]})]},s))},R=e=>{const t=y[e]||[],n=d(e),l=Object.keys(n.fields);return t.length===0?a.jsx("tr",{children:a.jsx("td",{colSpan:l.length+1,className:"text-center py-3 text-muted",children:"No transactions added yet"})}):t.map(s=>a.jsxs("tr",{className:"align-middle",children:[l.map(r=>a.jsx("td",{className:"py-2",children:r==="amount"?a.jsx("span",{className:"fw-bold",children:D(s[r])}):a.jsx("span",{children:s[r]})},r)),a.jsx("td",{className:"py-2",children:a.jsx($,{variant:"outline-danger",size:"sm",className:"rounded-0",onClick:()=>P(e,s.id),title:"Remove transaction",children:a.jsx(V,{})})})]},s.id))};return T?a.jsx(i,{className:"border-0 rounded-0 shadow-sm mt-2",children:a.jsxs(i.Body,{className:"text-center py-4",children:[a.jsx(J,{animation:"border",variant:"primary"}),a.jsx("p",{className:"mt-2 mb-0",children:"Loading payment methods..."})]})}):A?a.jsx(i,{className:"border-0 rounded-0 shadow-sm mt-2",children:a.jsx(i.Body,{children:a.jsxs(F,{variant:"danger",className:"mb-0",children:["Error loading payment methods: ",A]})})}):!c||c.length===0?a.jsx(i,{className:"border-0 rounded-0 shadow-sm mt-2",children:a.jsx(i.Body,{className:"text-center py-4",children:a.jsx("p",{className:"mb-0 text-muted",children:"No payment methods available"})})}):a.jsx(i,{className:"border-0 rounded-0 shadow-sm mt-2",children:a.jsx(i.Body,{children:a.jsx(X,{activeKey:E,onSelect:v,transition:!1,className:"mb-3",children:c.map(e=>{const t=e.code,n=e.is_active!==!1;return a.jsx(Z,{eventKey:t,title:a.jsxs("div",{className:`d-flex align-items-center ${n?"":"text-muted"}`,children:[k(t),a.jsx("span",{children:e.name}),e.is_default&&a.jsx("span",{className:"badge bg-primary ms-2 small",children:"Default"})]}),disabled:!n,children:n?a.jsxs("div",{className:"mt-3",children:[e.description&&a.jsx("p",{className:"text-muted mb-3 small",children:e.description}),a.jsx("div",{className:"table-responsive",children:a.jsxs(C,{striped:!0,bordered:!0,hover:!0,size:"sm",className:"mb-0",children:[a.jsx("thead",{className:"table-light",children:a.jsxs("tr",{children:[Object.values(d(t).fields).map((l,s)=>a.jsx("th",{className:"py-2 px-2",children:l.label},s)),a.jsx("th",{className:"py-2 px-2",style:{width:"80px"},children:"Action"})]})}),a.jsxs("tbody",{children:[R(t),a.jsxs("tr",{className:"bg-light",children:[M(t),a.jsx("td",{className:"p-1 align-middle",children:a.jsx($,{variant:"success",className:"rounded-0 w-100",onClick:()=>O(t),size:"sm",title:"Add payment",children:a.jsx(z,{})})})]})]})]})}),e.account_number&&a.jsxs("div",{className:"mt-3 small",children:[a.jsx("div",{className:"text-muted",children:"Account Details:"}),a.jsxs("div",{children:[a.jsx("strong",{children:"Bank:"})," ",e.bank_name||"N/A"," ","| ",a.jsx("strong",{children:"Account:"})," ",e.account_number," |"," ",a.jsx("strong",{children:"Name:"})," ",e.account_name||"N/A"]})]})]}):a.jsx(F,{variant:"info",className:"mt-3",children:"This payment method is currently inactive"})},e.id)})})})})};export{pe as P};
